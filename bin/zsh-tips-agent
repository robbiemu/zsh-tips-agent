#!/usr/bin/env bash
set -euo pipefail

SNIPPET='
# ---- zsh-tips-agent ----
TIPS_AGENT_DIR="${GH:-$HOME/Github}/zsh-tips-agent"
TIP_CACHE_FILE="$TIPS_AGENT_DIR/data/current_tip.txt"
UPDATE_SCRIPT="$TIPS_AGENT_DIR/bin/update_tip_cache.sh"

if [[ -f "$TIP_CACHE_FILE" ]]; then
  cat "$TIP_CACHE_FILE"
  [[ -x "$UPDATE_SCRIPT" ]] && "$UPDATE_SCRIPT" &!
else
  MSG="ğŸ¤– Generating your first tip... (this may take a moment!)"
  echo "$MSG"
  [[ -x "$UPDATE_SCRIPT" ]] && "$UPDATE_SCRIPT" &!
fi
# ---- /zsh-tips-agent ----

'

usage() {
  echo "Usage: zsh-tips-agent init [--apply|--print]" >&2
  exit 1
}

init() {
  if [[ "${1:-}" == "--print" ]]; then
    echo "$SNIPPET"
    exit 0
  fi

  ZSHRC="$HOME/.zshrc"
  if ! grep -q 'zsh-tips-agent ----' "$ZSHRC"; then
    printf "\n%s\n" "$SNIPPET" >> "$ZSHRC"
    echo "âœ… Added zshâ€‘tipsâ€‘agent snippet to $ZSHRC"
  else
    echo "â„¹ï¸  zshâ€‘tipsâ€‘agent snippet already present in $ZSHRC"
  fi
}

[[ $# -lt 1 ]] && usage
case "$1" in
  init) shift; init "$@";;
  *) usage;;
esac
