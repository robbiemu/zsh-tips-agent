#!/usr/bin/env bash
set -euo pipefail

# ---- Paths & Defaults ----
PREFIX=${PREFIX:-/usr/local}
BIN_DIR="$PREFIX/bin"
TIPS_AGENT_DIR="${GH:-$HOME/Github}/zsh-tips-agent"
UPDATE_SCRIPT="$TIPS_AGENT_DIR/bin/update_tip_cache.sh"
SNIPPET=''
# ---- zsh-tips-agent ----
TIPS_AGENT_DIR="${GH:-$HOME/Github}/zsh-tips-agent"
TIP_CACHE_FILE="$TIPS_AGENT_DIR/data/current_tip.txt"
UPDATE_SCRIPT="$TIPS_AGENT_DIR/bin/update_tip_cache.sh"
TIP_AGE_HOURS=2

tip_is_fresh() {
  [[ ! -f "$TIP_CACHE_FILE" ]] && return 1
  now=$(date +%s)
  filetime=$(stat -f %m "$TIP_CACHE_FILE" 2>/dev/null)
  (( ((now - filetime)/3600) < TIP_AGE_HOURS ))
}

[[ -f "$TIP_CACHE_FILE" ]] && cat "$TIP_CACHE_FILE"

if ! tip_is_fresh; then
  [[ -x "$UPDATE_SCRIPT" ]] && "$UPDATE_SCRIPT" > /dev/null 2>&1 &!
fi
# ---- /zsh-tips-agent ----
'SNIPPET'

usage() {
  cat <<EOF >&2
Usage: zsh-tips-agent <command> [options]

Commands:
  install              Copy scripts to \$BIN_DIR (default /usr/local/bin)
  init [--apply|--print]  Add or display the snippet for ~/.zshrc
  help                 Show this message
EOF
  exit 1
}

cmd_install() {
  echo "Installing zsh-tips-agent to \$BIN_DIR..."
  mkdir -p "$BIN_DIR"
  install -m755 "$TIPS_AGENT_DIR/bin/zsh-tips-agent" "$BIN_DIR/zsh-tips-agent"
  install -m755 "$TIPS_AGENT_DIR/bin/update_tip_cache.sh" "$BIN_DIR/update_tip_cache.sh"
  echo "Done."
  echo "Add to your ~/.zshrc:"
  echo
  echo "  eval \"\\$(zsh-tips-agent init --print)\""
}

cmd_init() {
  if [[ "${1:-}" == "--print" ]]; then
    # print snippet
    echo "$SNIPPET"
    exit 0
  fi
  # apply snippet
  ZSHRC="$HOME/.zshrc"
  if ! grep -q 'zsh-tips-agent ----' "$ZSHRC"; then
    printf "\n%s\n" "$SNIPPET" >> "$ZSHRC"
    echo "✅ Added zsh‑tips‑agent snippet to $ZSHRC"
  else
    echo "ℹ️  zsh‑tips‑agent snippet already present in $ZSHRC"
  fi
}

# dispatch
case "${1:-help}" in
  install) cmd_install ;; 
  init)    shift; cmd_init "$@" ;; 
  help|--help|-h) usage ;; 
  *) usage ;; 
esac
